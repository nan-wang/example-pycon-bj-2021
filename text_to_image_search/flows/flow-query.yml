jtype: Flow                                       # This file defines the query flow which is used for searching in the indexed documents
version: '1'                                      # The query flow is very similar to the index flow - only the differences are explained here
with:
  port_expose: $JINA_PORT
  protocol: 'http'
  cors: True
  workspace: $JINA_WORKSPACE
pods:
  - name: loader                                  # Again, we start two paths in the flow - here we start the image path
    uses: ImageReader
    py_modules: 'executors.py'
  - name: image_encoder                           # Now, encode the images and compute the embeddings
    uses: 'jinahub+docker://CLIPImageEncoder/v0.3'
    volumes: $HOME/.cache/huggingface:/root/.cache/huggingface
  - name: text_filter                             # Here, the text path starts
    uses: TextFilter
    py_modules: 'executors.py'
    needs: 'gateway'
  - name: text_encoder                            # Compute the embedding of the search text
    uses: 'jinahub+docker://CLIPTextEncoder/v0.1'
    volumes: $HOME/.cache/huggingface:/root/.cache/huggingface
  - name: merger
    uses: 'jinahub+docker://MatchMerger'
    needs:
      - 'text_encoder'
      - 'image_encoder'
  - name: image_indexer                           # Executor that stores image embeddings
    uses: 'jinahub://PQLiteIndexer/latest'
    install_requirements: True
    uses_with:
      startup_sync: False
      dim: 512
      metric: 'cosine'
      include_metadata: True
    uses_after: RemoveEmbedding
    py_modules: 'executors.py'
